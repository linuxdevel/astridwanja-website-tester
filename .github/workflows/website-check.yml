name: Build rankings and check website

on:
  schedule:
    # Run at 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_issues: ${{ steps.evaluate.outputs.has_issues }}
      pages_ready: ${{ steps.mark_pages_ready.outputs.pages_ready }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Python deps and browsers
        run: make install-browsers

      - name: Install Playwright system dependencies
        run: sudo .venv/bin/playwright install-deps chromium

      - name: Generate rankings snapshot
        id: build_rankings
        run: .venv/bin/python ranking/build_rankings.py

      - name: Run website checker
        id: run_checker
        env:
          BASE_URL: https://astridwanja.com
        run: |
          .venv/bin/python scripts/website_checker.py \
            --json-output website-check-report.json \
            --markdown-output website-check-report.md \
            --html-output website-check-report.html

      - name: Evaluate website check report
        id: evaluate
        if: steps.run_checker.outcome == 'success'
        run: |
          .venv/bin/python - <<'PY'
          import json
          import os
          from pathlib import Path

          data = json.loads(Path("website-check-report.json").read_text(encoding="utf-8"))
          has_issues = bool(data.get("has_issues"))
          issues = data.get("issues", [])
          warnings = data.get("warnings", [])
          issue_count = len(issues)
          warning_count = len(warnings)
          summary_lines = [
              f"Base URL: {data.get('base_url')}",
              f"Pages checked: {data.get('checked_pages')}",
              f"Links checked: {data.get('checked_links')}",
              f"Images checked: {data.get('checked_images')}",
              f"Issues found: {issue_count}",
          ]
          if warning_count:
              summary_lines.append(f"Warnings: {warning_count}")
          summary = "\n".join(summary_lines)
          Path("website-check-summary.txt").write_text(summary, encoding="utf-8")

          print("----- Website checker summary -----")
          for line in summary_lines:
              print(line)

          if issues:
              print("\nIssues:")
              for issue in issues:
                  kind = issue.get("kind")
                  message = issue.get("message")
                  source = issue.get("source")
                  target = issue.get("target")
                  status = issue.get("status_code")
                  parts = [f"[{kind}] {message}"]
                  if source:
                      parts.append(f"source={source}")
                  if target:
                      parts.append(f"target={target}")
                  if status is not None:
                      parts.append(f"status={status}")
                  print(" - " + "; ".join(parts))

          if warning_count:
              print("\nWarnings:")
              for warning in warnings:
                  kind = warning.get("kind")
                  message = warning.get("message")
                  source = warning.get("source")
                  target = warning.get("target")
                  status = warning.get("status_code")
                  parts = [f"[{kind}] {message}"]
                  if source:
                      parts.append(f"source={source}")
                  if target:
                      parts.append(f"target={target}")
                  if status is not None:
                      parts.append(f"status={status}")
                  print(" - " + "; ".join(parts))

          step_summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if step_summary:
              with open(step_summary, "a", encoding="utf-8") as summary_file:
                  summary_file.write("## Website checker results\n\n")
                  summary_file.write(summary + "\n")
                  if warning_count:
                      summary_file.write("\n### Warnings\n")
                      for warning in warnings:
                          message = warning.get("message", "")
                          target = warning.get("target")
                          summary_file.write(f"- {message} (target: {target})\n")

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"has_issues={'true' if has_issues else 'false'}\n")
              fh.write("summary<<EOF\n")
              fh.write(summary + "\n")
              fh.write("EOF\n")
              fh.write(f"warnings={warning_count}\n")

          if has_issues:
              print("::warning::Website checker detected issues. See attached report.")
          else:
              print("Website checker found no issues.")
          PY

      - name: Upload report artifacts
        if: steps.run_checker.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: website-check-report
          path: |
            website-check-report.json
            website-check-report.md
            website-check-report.html
            website-check-summary.txt

      - name: Prepare unified GitHub Pages artifact
        id: prepare_pages
        if: steps.build_rankings.outcome == 'success' || steps.run_checker.outcome == 'success'
        run: |
          mkdir -p public
          
          # Copy rankings if they exist
          if [ -d docs/rankings ]; then
            echo "Including rankings in deployment..."
            cp -r docs/rankings public/
          fi
          
          # Copy website check reports if they exist
          if [ -f website-check-report.html ]; then
            echo "Including website check reports in deployment..."
            mkdir -p public/website-check
            cp website-check-report.html public/website-check/index.html
            cp website-check-report.json public/website-check/
            cp website-check-report.md public/website-check/
            cp website-check-summary.txt public/website-check/
          fi
          
          # Create a simple index.html at root
          cat > public/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Astrid Wanja - Reports</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                  }
                  h1 { color: #333; }
                  .report-link {
                      display: block;
                      padding: 15px;
                      margin: 10px 0;
                      background: #f5f5f5;
                      border-radius: 5px;
                      text-decoration: none;
                      color: #0366d6;
                      transition: background 0.2s;
                  }
                  .report-link:hover {
                      background: #e5e5e5;
                  }
              </style>
          </head>
          <body>
              <h1>Astrid Wanja - Automated Reports</h1>
              <p>Available reports:</p>
              <a href="rankings/wta.html" class="report-link">üéæ WTA Rankings</a>
              <a href="rankings/" class="report-link">üìä Full ITF Rankings</a>
              <a href="website-check/" class="report-link">üîç Website Check Report</a>
          </body>
          </html>
          EOF
          
          echo "GitHub Pages artifact prepared with the following structure:"
          ls -R public/

      - name: Upload Pages artifact
        id: upload_pages
        if: steps.prepare_pages.outcome == 'success'
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Mark Pages artifact ready
        id: mark_pages_ready
        if: steps.upload_pages.outcome == 'success'
        run: echo "pages_ready=true" >> "$GITHUB_OUTPUT"

  deploy:
    needs: build
    if: ${{ needs.build.outputs.pages_ready == 'true' && github.ref == 'refs/heads/master' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Print GitHub Pages URLs
        run: |
          echo "::notice::GitHub Pages deployed successfully!"
          echo "::notice::View reports at:"
          echo "::notice::  - Main index: ${{ steps.deployment.outputs.page_url }}"
          echo "::notice::  - WTA Rankings: ${{ steps.deployment.outputs.page_url }}rankings/wta.html"
          echo "::notice::  - Full ITF Rankings: ${{ steps.deployment.outputs.page_url }}rankings/"
          echo "::notice::  - Website check: ${{ steps.deployment.outputs.page_url }}website-check/"
          echo ""
          echo "=== GitHub Pages URLs ==="
          echo "Main index: ${{ steps.deployment.outputs.page_url }}"
          echo "WTA Rankings: ${{ steps.deployment.outputs.page_url }}rankings/wta.html"
          echo "Full ITF Rankings: ${{ steps.deployment.outputs.page_url }}rankings/"
          echo "Website check: ${{ steps.deployment.outputs.page_url }}website-check/"
